(()=>{var v=class extends Error{constructor(t,n){super(t);this.node=n}},S=class extends Error{constructor(t,n){super(t);this.node=n}},R=class extends S{};function Q(e,t){return{type:"function",environment:e,body:t}}function p(e){return{type:"native-function",body:e}}function H(e){return e!==null&&typeof e=="object"&&e.type==="function"}function X(e){return e!==null&&typeof e=="object"&&e.type==="native-function"}function y(e){if(typeof e!="object")return String(e);if(e===null)return"null";switch(e.type){case"function":return"[Function]";case"native-function":return"[Native Function]"}}function L(e){return typeof e=="number"?e:parseInt(y(e).trim(),10)}function w(e){return!!e}function I(e,t){return typeof e!="object"||typeof t!="object"||e===null||t===null,e===t}function Y(e,t){throw new S(`Variable '${e}' not found`,t)}function G(e,t){throw new S(`Slot '${e}' not found`,t)}function D(e,t,n){throw new S(`Value '${y(t)}' is not ${e}`,n)}function g(e,t){throw new S(`Expected at least ${e} argument${e>1?"s":""}.`,t)}function W(e){throw new S("Unexpected end of input.",e)}function z(){return{scopes:[]}}function J(e){return{bindings:new Map,functionParameters:e}}function Be(e,t){let{scopes:n}=e;for(let r=n.length-1;r>=0;r--){let o=n[r]?.bindings.get(t);if(o!==void 0)return o}}function B(e,t,n){let r=Be(e,t);return r===void 0&&Y(t,n),r}function M(e,t,n,r){let o=e.scopes[e.scopes.length-1];if(!o)throw new R("No scope",r);o.bindings.set(t,n)}function K(e,t,n,r){let{scopes:o}=e;for(let i=o.length-1;i>=0;i--){let s=o[i];if(s?.bindings.has(t)){s.bindings.set(t,n);return}}throw new R(`No binding of name '${t}'`,r)}function Me(e,t){let{scopes:n}=e,r=n[n.length-1];return r?r.functionParameters[Number(t)]:void 0}function Z(e,t,n){let r=Me(e,t);return r===void 0&&G(t,n),r}function x(e){return e.nodeType===Node.ELEMENT_NODE}function ee(e){return e.nodeType===Node.TEXT_NODE||e.nodeType===Node.CDATA_SECTION_NODE}function C(e,t){return t.length>=e}function c(e){return e.length>0}function te(e){let t="";return{get:async r=>{let o=t.match(r);for(;o===null||!c(o);){let i=await e.input();if(i===void 0)return;t+=i,o=t.match(r)}return t=t.slice(o[0].length),o}}}function A(e){return e}async function P(e,t){let n=[];for(let r of e)n.push(await t(r));return n}function a(e){if(e===null)return Number.NaN;if(typeof e!="object")return Number(e);switch(e.type){case"function":case"native-function":return Number.NaN}}var ne={plus:p(e=>{let t=0;for(let n of e)t+=a(n);return t}),minus:p(e=>{if(!c(e))return 0;let t=a(e[0]);for(let n of e.slice(1))t-=a(n);return t}),times:p(e=>{let t=1;for(let n of e)t*=a(n);return t}),divide:p(e=>{if(!c(e))return 1;let t=a(e[0]);for(let n of e.slice(1))t/=a(n);return t}),power:p(e=>{if(!c(e))return 1;let t=a(e[0]);for(let n of e.slice(1))t**=a(n);return t}),rem:p((e,t)=>(C(2,e)||g(2,t),a(e[0])%a(e[1]))),gcd:p(e=>{if(!c(e))return 1;let t=a(e[0]);for(let r of e.slice(1))t=n(t,a(r));return t;function n(r,o){for(r<o&&([r,o]=[o,r]);o!==0;)[r,o]=[o,r%o];return r}}),min:p(e=>Math.min(...e.map(a))),max:p(e=>Math.max(...e.map(a))),eq:p((e,t)=>(C(2,e)||g(2,t),+I(e[0],e[1]))),neq:p((e,t)=>(C(2,e)||g(2,t),+!I(e[0],e[1]))),lt:p((e,t)=>{c(e)||g(1,t);let[n,...r]=e,o=a(n);for(let i of r){let s=a(i);if(!(o<s))return 0;o=s}return 1}),gt:p((e,t)=>{c(e)||g(1,t);let[n,...r]=e,o=a(n);for(let i of r){let s=a(i);if(!(o>s))return 0;o=s}return 1}),leq:p((e,t)=>{c(e)||g(1,t);let[n,...r]=e,o=a(n);for(let i of r){let s=a(i);if(!(o<=s))return 0;o=s}return 1}),geq:p((e,t)=>{c(e)||g(1,t);let[n,...r]=e,o=a(n);for(let i of r){let s=a(i);if(!(o>=s))return 0;o=s}return 1}),and:p(e=>+e.reduce((t,n)=>t&&w(n),!0)),or:p(e=>+e.reduce((t,n)=>t||w(n),!1)),xor:p(e=>+e.reduce((t,n)=>t?!w(n):w(n),!1)),implies:p((e,t)=>(c(e)||g(1,t),+e.map(w).reduceRight((n,r)=>!r||n)))};async function u(e,t){switch(e.type){case"OutputExpression":{let n=await u(e.expression,t);return t.io.output(y(n)),n}case"TextExpression":return e.text;case"ConcatExpression":{let n=[];for(let r of e.expressions)n.push(y(await u(r,t)));return n.join("")}case"AbbrExpression":{let n=typeof e.title=="string"?B(t.environment,e.title,e.node):await u(e.title,t),r=await P(e.parameters,o=>u(o,t));if(H(n))return await Ce(n,r,t);if(X(n))return await n.body(r,e.node);D("function",n,e.node)}case"QExpression":{let n=e.cite,r=await P(e.parameters,o=>u(o,t));if(n=="string/charCodeAt"){let o=r;if(o.length<2)return-1;let i=y(o[0]||""),s=L(o[1]||-1);return s<0||s>=i.length?-1:i.charCodeAt(s)}D("function",n,e.node)}case"SlotExpression":return Z(t.environment,e.name,e.node);case"VarExpression":{let n=await u(e.name,t);return B(t.environment,y(n),e.node)}case"MathBuiltInExpression":return ne[e.name];case"InputExpression":{let n=new RegExp("^"+(e.pattern??".*\\n"),"u");if(e.name===void 0){let r=await t.input.get(n);return r===void 0&&W(e.node),r[1]??r[0]??null}else{let r=y(B(t.environment,e.name,e.node)),o=n.exec(r);if(o===null||!c(o))return null;let i=o[1]??o[0];return K(t.environment,e.name,r.slice(o[0].length),e.node),i}}case"RubyExpression":{let n=await u(e.expression,t);for(let{condition:r,then:o}of e.branches){let i=await u(r,t);if(I(n,i))return u(o,t)}return e.else?u(e.else,t):null}case"SpanExpression":return u(e.expression,t);case"MeterExpression":return L(await u(e.expression,t));default:A(e)}}async function Ce(e,t,n){let r=await re(e.body,n,t);switch(r.type){case"normal":return null;case"footer":return r.value;default:A(r)}}var k={type:"normal"};async function oe(e,t){switch(e.type){case"ExpressionStatement":return await u(e.expression,t),k;case"FooterStatement":{let n=await u(e.expression,t);return{type:"footer",value:n}}case"DefinitionListStatement":{for(let{name:n,value:r}of e.definitions){let o=y(await u(n,t)),i=await u(r,t);M(t.environment,o,i,e.node)}return k}case"SectionDeclaration":return k;default:A(e)}}function ae(e,t){let n=ie(e,t.environment,[]),r={...t,environment:n};return se(e,r)}function re(e,t,n){let r=ie(e,t.environment,n),o={...t,environment:r};return se(e,o)}function ie(e,t,n){let r=J(n),o={scopes:[...t.scopes,r]};for(let i of e)switch(i.type){case"SectionDeclaration":{let s=Q(o,i.body);M(o,i.title,s,i.node);break}}return o}async function se(e,t){for(let n of e){let r=await oe(n,t);if(r.type==="footer")return{type:"footer",value:r.value}}return{type:"normal"}}function pe(e){return{async run(t){let n={io:e,input:te(e),environment:z()};await ae(t.statements,n)}}}function ue(e,t){return{type:"OutputExpression",expression:t,node:e}}function q(e,t,n){return{type:"AbbrExpression",title:t,parameters:n,node:e}}function U(e,t,n){return{type:"QExpression",cite:t,parameters:n,node:e}}function F(e,t){return{type:"TextExpression",text:t,node:e}}function ce(e,t){return{type:"SlotExpression",name:t,node:e}}function le(e,t){return{type:"VarExpression",name:t,node:e}}function de(e,t){return{type:"MathBuiltInExpression",name:t,node:e}}function me(e,t,n){return{type:"InputExpression",name:t,pattern:n,node:e}}function j(e,t,n,r){return{type:"RubyExpression",expression:t,branches:n,else:r,node:e}}function _(e,t){return{type:"SpanExpression",expression:t,node:e}}function xe(e,t){return{type:"MeterExpression",expression:t,node:e}}function fe(e,t){return{type:"ConcatExpression",expressions:t,node:e}}function $(e){let t=[],n=e.concat([]);for(;n.length>0;){let r=h(n);if(!r)break;let[o,i]=r;t.push(o),n=i;let s=n[0];s&&x(s)&&s.tagName==="BR"&&(n=i.slice(1))}return l(n),t}function d(e){for(let[t,n]of e.entries())switch(n.nodeType){case Node.COMMENT_NODE:case Node.PROCESSING_INSTRUCTION_NODE:case Node.DOCUMENT_TYPE_NODE:continue;case Node.TEXT_NODE:if(!n.nodeValue||/^\s*$/.test(n.nodeValue))continue;default:return t===0?e:e.slice(t)}return[]}function T(e){throw new v("Unexpected node",e)}function m(e,t){throw new v(`Expected ${e}.`,t)}function Ee(e,t){throw new v(`Expected an attribute '${e}' to exist.`,t)}function Ne(e){let n=d(Array.from(e.childNodes))[0];(n===void 0||!x(n))&&m("an element",e);let r=n.tagName.toLowerCase();return Fe(r)||m("one of: "+Array.from(ye.values()).join(", "),n),de(n,r)}var ye=new Set(["plus","minus","times","divide","rem","power","gcd","min","max","eq","neq","lt","gt","leq","geq","and","or","xor","implies"]);function Fe(e){return ye.has(e)}function h(e){let t=he(e);if(t===void 0)return;let[n,r]=t,o=[n],i=r;for(;;){let E=he(i);if(E===void 0)break;let[N,V]=E;o.push(N),i=V}let s=o.length===1?n:fe(n.node,o);i=d(i);let f=i[0];return f!==void 0&&x(f)&&f.tagName==="RUBY"?[Oe(f,s),i.slice(1)]:[s,i]}function he(e){let t=d(e),n=t[0];if(!!n){if(x(n))switch(n.tagName){case"WBR":return[F(n,`
`),t.slice(1)];case"OUTPUT":{let[r,o]=b(Array.from(n.childNodes),n);return[ue(n,r),t.slice(1)]}case"ABBR":{let r=$(Array.from(n.childNodes)),o=n.getAttribute("title");if(o===null){let[i,...s]=r;if(i===void 0)throw new v("Expected at least one expressions as children",n);return[q(n,i,s),t.slice(1)]}return[q(n,o,r),t.slice(1)]}case"Q":{let r=$(Array.from(n.childNodes)),o=n.getAttribute("cite");if(o===null){let[i,...s]=r;if(i===void 0)throw new v("Expected at least one expressions as children",n);return[U(n,i,s),t.slice(1)]}return[U(n,o,r),t.slice(1)]}case"SLOT":{let r=n.getAttribute("name")??"0";return[ce(n,r),t.slice(1)]}case"VAR":{let[r,o]=b(Array.from(n.childNodes),n);return l(o),[le(n,r),t.slice(1)]}case"math":return[Ne(n),t.slice(1)];case"INPUT":{let r=n.getAttribute("type");r!==null&&r!=="text"&&T(n);let o=n.getAttribute("name")??void 0,i=n.getAttribute("pattern")??void 0;return[me(n,o,i),t.slice(1)]}case"SPAN":{let r=Array.from(n.childNodes),o=h(r);if(o===void 0)return l(r),[_(n,F(n,"")),t.slice(1)];let[i,s]=o;return l(s),[_(n,i),t.slice(1)]}case"METER":{let r=h(Array.from(n.childNodes));r===void 0&&m("some child",n);let[o,i]=r;return l(i),[xe(n,o),t.slice(1)]}}else if(ee(n))return[F(n,n.nodeValue||""),t.slice(1)]}}function Oe(e,t){let n=d(Array.from(e.childNodes)),r=[];for(;n.length>0;){let o=h(n);if(o!==void 0){let[i,s]=o,f=d(s),E=f[0];(E===void 0||!x(E)||E.tagName!=="RT")&&m("an rt element",E??e);let[N,V]=b(Array.from(E.childNodes),E);l(V),r.push({condition:i,then:N}),n=d(f.slice(1))}else{let i=n[0];(i===void 0||!x(i)||i.tagName!=="RT")&&m("an expression or an rt element",i??e);let[s,f]=b(Array.from(i.childNodes),i);return l(f),j(e,t,r,s)}}return j(e,t,r,void 0)}function b(e,t){let n=h(e);return n===void 0&&m("expression",e[0]||t),n}function l(e){let t=d(e);c(t)&&T(t[0])}function ge(e,t){let n=e.getAttribute(t);return n===null&&Ee(t,e),n}function ve(e,t){return{type:"ExpressionStatement",expression:t,node:e}}function Se(e,t){return{type:"FooterStatement",expression:t,node:e}}function be(e,t){return{type:"DefinitionListStatement",definitions:t,node:e}}function we(e,t,n){return{type:"SectionDeclaration",title:t,body:n,node:e}}function Te(e){let t=d(e),n=t[0];if(!!n)switch(x(n)||T(n),n.tagName){case"P":{let[r,o]=b(Array.from(n.childNodes),n);return l(o),[ve(n,r),t.slice(1)]}case"FOOTER":{let[r,o]=b(Array.from(n.childNodes),n);return l(o),[Se(n,r),t.slice(1)]}case"DL":{let r=d(Array.from(n.childNodes)),o=[];for(;r.length>0;){let[i,...s]=r;(i===void 0||!x(i)||i.tagName!=="DT")&&m("a dt element",i??n);let[f,E]=h(Array.from(i.childNodes))||m("an element",i);l(E);let[N,...V]=d(s);(N===void 0||!x(N)||N.tagName!=="DD")&&m("a dd element",N??n);let[Ae,Re]=h(Array.from(N.childNodes))||m("an element",N);l(Re),o.push({name:f,value:Ae}),r=d(V)}return[be(n,o),t.slice(1)]}case"SECTION":{let r=ge(n,"title"),o=O(Array.from(n.childNodes));return[we(n,r,o),t.slice(1)]}}}function O(e){let t=[],n=e.concat([]);for(;n.length>0;){let r=Te(n);if(!r)break;let[o,i]=r;t.push(o),n=i}return l(n),t}function Ve(e){return{statements:O(Array.from(e.childNodes))}}document.readyState!=="loading"?Ie(document.body):document.addEventListener("DOMContentLoaded",()=>{Ie(document.body)});async function Ie(e){let t=document.createElement("main");Le(e,t);let n=Ve(t);console.debug("parsed",n);let{outputContainer:r}=De();await pe({input:async()=>{},output:i=>{console.log(i),r.append(i)}}).run(n)}function Le(e,t){let n=document.createRange();n.selectNodeContents(e),t.appendChild(n.extractContents())}function De(){let e=document.createElement("style");e.textContent=`
html, body, pre.output {
  height: 100%;
}
`,document.head.append(e);let t=document.createElement("pre");return t.classList.add("output"),document.body.appendChild(t),{outputContainer:t}}})();
